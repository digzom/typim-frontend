# ADR-006: State and Event Contract Hardening

## Status

Accepted

## Context

`StateManager.dispatch` previously accepted typed input only at compile time and returned raw state, while `EventBus` did not guarantee source propagation or `subscribeAll` parity.

## Decision

Harden contracts with runtime validation and canonical envelopes:

- `StateManager.dispatch(action: unknown)` validates action shape/payload and returns structured result metadata.
- `EventBus.emit(...)` emits canonical envelopes with source and timestamp and returns delivery metadata.
- `subscribeAll` receives the same envelope path as event-specific subscribers.

## Consequences

### Positive

- Invalid actions are isolated and do not mutate state.
- Event provenance is explicit for debugging and audit trails.

### Negative

- Contract changes require compatibility handling for legacy return-value usage.

### Neutral

- Existing valid `emit(event, payload)` call sites remain compatible via `source='unknown'`.

## Related

- `src/core/state.ts`
- `src/core/event-bus.ts`
- `docs/api/state-manager-dispatch-v2.md`
- `docs/api/event-bus-envelope-v2.md`
- `tests/unit/core/state.test.ts`
- `tests/unit/core/event-bus.test.ts`
